<div class="min-h-screen bg-background text-foreground pb-12 font-sans selection:bg-primary/20">
  <!-- Loading State -->
  @if (isLoading()) {
  <div class="flex flex-col items-center justify-center min-h-[60vh] gap-4 text-muted-foreground">
    <ng-icon name="lucideLoader2" class="text-4xl animate-spin text-primary"></ng-icon>
    <p class="text-sm font-medium tracking-wide">Retrieving Intelligence Dossier...</p>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="flex flex-col items-center justify-center min-h-screen gap-6 p-8 text-center animate-fade-in-up">
    <div class="w-20 h-20 rounded-3xl bg-rose-500/10 flex items-center justify-center">
      <ng-icon name="lucideBuilding2" class="text-4xl text-rose-500"></ng-icon>
    </div>
    <div class="space-y-2">
      <h2 class="text-2xl font-black tracking-tight">Access Denied</h2>
      <p class="text-muted-foreground max-w-sm mx-auto">{{ error() }}</p>
    </div>
    <button hlmBtn variant="outline" (click)="goBack()" class="rounded-2xl">
      <ng-icon name="lucideArrowLeft" class="mr-2"></ng-icon>
      Return to Dashboard
    </button>
  </div>
  }

  <!-- Main Content -->
  @if (!isLoading() && !error() && companyDetails(); as details) {
  <div class="max-w-[1400px] mx-auto px-6 lg:px-8 pt-8 space-y-10">

    <!-- Header Block: Identity & Controls -->
    <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-8 pb-4 animate-fade-in-up">
      <div class="space-y-6">
        <!-- Back Button -->
        <button (click)="goBack()"
          class="flex items-center gap-2 text-xs font-black uppercase tracking-[0.2em] text-muted-foreground hover:text-primary transition-colors group">
          <ng-icon name="lucideArrowLeft" class="group-hover:-translate-x-1 transition-transform"></ng-icon>
          Return
        </button>

        <div class="flex items-center gap-6">
          <!-- Logo -->
          <div
            class="h-24 w-24 rounded-3xl bg-card border-2 border-border/40 p-4 shadow-sm flex items-center justify-center overflow-hidden shrink-0">
            @if (getLogoUrl() && !logoFailed()) {
            <img [src]="getLogoUrl()" [alt]="details.name" class="h-full w-full object-contain"
              (error)="onLogoError()" />
            } @else {
            <ng-icon name="lucideBuilding2" class="text-4xl text-muted-foreground/40"></ng-icon>
            }
          </div>

          <div class="space-y-2">
            <div class="flex items-center gap-3">
              <h1 class="text-5xl font-black tracking-tight text-foreground leading-none">
                {{ details.name }}
              </h1>
              <span hlmBadge variant="outline"
                class="rounded-lg px-3 py-1 text-[10px] font-black uppercase border-primary/20 bg-primary/5 text-primary">
                {{ details.totalApplications > 0 ? 'Active Priority' : 'Target Asset' }}
              </span>

              <!-- Priority Dropdown -->
              <div class="relative">
                @for (opt of priorityOptions; track opt.value) {
                @if (details.priority === opt.value) {
                <button [hlmDropdownMenuTrigger]="priorityMenu" hlmBtn variant="ghost" size="sm"
                  class="rounded-full px-4 py-1.5 h-auto text-[10px] font-black uppercase tracking-wider transition-all duration-300 group/priority border ring-1 ring-border/50 hover:ring-border/80"
                  [ngClass]="opt.bg + ' ' + opt.color + ' ' + opt.border">
                  <ng-icon [name]="opt.icon" class="mr-1.5" size="14"></ng-icon>
                  {{ opt.label }}
                  <ng-icon name="lucideChevronDown"
                    class="ml-1.5 opacity-50 group-hover/priority:opacity-100 transition-opacity" size="12"></ng-icon>
                </button>
                }
                }

                <ng-template #priorityMenu>
                  <div hlmDropdownMenu
                    class="w-60 p-2 rounded-2xl backdrop-blur-xl bg-popover/95 border-border shadow-2xl">
                    <div class="px-3 py-2 text-[10px] font-black uppercase tracking-widest text-muted-foreground/50">
                      Set Strategic Priority
                    </div>
                    <div class="h-px bg-border/40 my-1"></div>

                    @for (opt of priorityOptions; track opt.value) {
                    <button hlmDropdownMenuItem (click)="updatePriority(opt.value)"
                      [class.bg-card]="details.priority === opt.value"
                      class="rounded-xl px-3 py-2.5 mb-1 text-xs font-bold flex items-center justify-between group transition-all">
                      <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg flex items-center justify-center transition-colors"
                          [ngClass]="details.priority === opt.value ? (opt.bg + ' ' + opt.color) : 'bg-muted text-muted-foreground group-hover:bg-muted/80'">
                          <ng-icon [name]="opt.icon" size="14"></ng-icon>
                        </div>
                        <span [class.text-foreground]="details.priority !== opt.value"
                          [class.text-primary]="details.priority === opt.value">
                          {{ opt.label }}
                        </span>
                      </div>

                      @if (details.priority === opt.value) {
                      <div class="w-1.5 h-1.5 rounded-full bg-primary shadow-[0_0_8px_rgba(var(--primary),0.5)]"></div>
                      }
                    </button>
                    }
                  </div>
                </ng-template>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 pt-1">
              @if (details.website; as website) {
              <a [href]="website" target="_blank"
                class="flex items-center gap-1.5 text-sm font-bold text-muted-foreground hover:text-primary transition-colors">
                <ng-icon name="lucideGlobe" size="16"></ng-icon>
                {{ website.replace('https://', '').replace('http://', '') }}
              </a>
              }
              <div class="h-4 w-px bg-border/60"></div>
              <div class="h-4 w-px bg-border/60"></div>

              <!-- Industry Dropdown -->
              <div class="relative">
                <button [hlmDropdownMenuTrigger]="industryMenu"
                  class="flex items-center gap-1.5 text-sm font-medium text-muted-foreground hover:text-primary transition-colors group/ind cursor-pointer">
                  {{ details.industry || 'Specify Industry' }}
                  <ng-icon name="lucideChevronDown"
                    class="text-[10px] opacity-50 group-hover/ind:opacity-100 transition-opacity"></ng-icon>
                </button>

                <ng-template #industryMenu>
                  <div hlmDropdownMenu class="w-48 max-h-64 overflow-y-auto custom-scrollbar p-1">
                    <div
                      class="px-2 py-1.5 text-[10px] font-black uppercase tracking-widest text-muted-foreground/50 sticky top-0 bg-popover z-10">
                      Market Sector
                    </div>
                    @for (ind of industryOptions; track ind) {
                    <button hlmDropdownMenuItem (click)="updateIndustry(ind)"
                      [class.bg-primary/10]="details.industry === ind"
                      class="rounded-lg text-xs font-bold w-full justify-between">
                      {{ ind }}
                      @if (details.industry === ind) {
                      <ng-icon name="lucideCheck" size="12" class="text-primary"></ng-icon>
                      }
                    </button>
                    }
                  </div>
                </ng-template>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex items-center gap-3">
        <button hlmBtn
          class="rounded-2xl h-12 w-12 p-0 bg-rose-600 text-white shadow-lg shadow-rose-500/30 hover:bg-rose-700 hover:scale-110 active:scale-95 transition-all flex items-center justify-center border-none"
          (click)="deleteCompany()">
          <ng-icon name="lucideTrash2" size="20"></ng-icon>
        </button>
      </div>
    </div>

    <!-- Bento Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 pb-20">

      <!-- Column 1: Stats & Meta (Span 3) -->
      <div class="lg:col-span-3 space-y-6">
        <!-- Stats Card 1: Engagement -->
        <div
          class="bg-card rounded-[2rem] border border-border/40 p-8 shadow-sm flex flex-col justify-between h-48 animate-fade-in-up delay-1">
          <p class="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 mb-2">Total Engagement
          </p>
          <div class="flex items-end justify-between">
            <h3 class="text-6xl font-black tracking-tighter">{{ details.totalApplications }}</h3>
            <div class="pb-2">
              <span class="text-xs font-bold text-muted-foreground uppercase">Apps</span>
            </div>
          </div>
        </div>

        <!-- Stats Card 2: Success Rate -->
        <div
          class="bg-card rounded-[2rem] border border-border/40 p-8 shadow-sm flex flex-col justify-between h-48 animate-fade-in-up delay-2">
          <p class="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/60 mb-2">Success Rate</p>
          <div class="flex items-end justify-between">
            <h3 class="text-6xl font-black tracking-tighter" [class.text-emerald-500]="getSuccessRate() > 0">
              {{ getSuccessRate() }}%
            </h3>
            <div class="flex flex-col items-end pb-2">
              <ng-icon [name]="getSuccessRate() > 0 ? 'lucideTrendingUp' : 'lucideTrendingDown'"
                [class]="getSuccessRate() > 0 ? 'text-emerald-500' : 'text-muted-foreground/30'" size="24"></ng-icon>
            </div>
          </div>
        </div>

        <!-- Tech Stack Block -->
        <div
          class="bg-muted/30 rounded-[2rem] border border-border/40 p-8 animate-fade-in-up delay-3 relative group/stack">
          <div class="flex items-center justify-between mb-6">
            <h4 class="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground/60">Environment Stack
            </h4>
            <button hlmBtn variant="ghost" size="icon-xs" class="h-6 w-6 p-0 rounded-full"
              (click)="editingTech.set(true)">
              <ng-icon name="lucidePlus" class="text-muted-foreground hover:text-primary transition-colors"></ng-icon>
            </button>
          </div>

          <div class="flex flex-wrap gap-2">
            @for (tech of details.techStack; track tech) {
            <span
              class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl bg-card border border-border/40 text-[11px] font-bold group/tag">
              {{ tech }}
              <button (click)="updateTechStack(tech)"
                class="opacity-0 group-hover/tag:opacity-100 hover:text-rose-500 transition-all">
                <ng-icon name="lucideX" class="text-[10px]"></ng-icon>
              </button>
            </span>
            }

            @if (editingTech()) {
            <div class="flex items-center gap-1 mt-2 w-full">
              <input hlmInput size="sm" class="h-7 py-0 px-2 text-[11px] flex-1" [ngModel]="newTech()"
                (ngModelChange)="newTech.set($event)" (keydown.enter)="addTechItem()"
                (keydown.escape)="editingTech.set(false)" placeholder="Add skill..." autofocus />
              <button hlmBtn variant="ghost" size="icon-xs" (click)="addTechItem()" class="h-7 w-7 p-0">
                <ng-icon name="lucideCheck" class="text-emerald-500"></ng-icon>
              </button>
            </div>
            }

            @if (!details.techStack?.length && !editingTech()) {
            <p class="text-xs font-medium text-muted-foreground/60 italic">No stack data available</p>
            }
          </div>
        </div>
      </div>

      <!-- Column 2: Core Intel (Span 6) -->
      <div class="lg:col-span-6 space-y-6">
        <!-- Strategy Notes (The Scratchpad) -->
        <div
          class="bg-card rounded-[2.5rem] border border-border/40 p-10 shadow-lg relative min-h-[400px] flex flex-col animate-fade-in-up delay-1">
          <div class="confidential-stamp">CONFIDENTIAL</div>

          <div class="flex items-center gap-3 mb-8">
            <div class="w-1.5 h-1.5 rounded-full bg-rose-500 animate-pulse"></div>
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-muted-foreground">Strategic Scratchpad</h3>
          </div>

          <textarea hlmInput [value]="companyNotes()" (input)="updateNotes($any($event.target).value)"
            placeholder="Operational notes, internal intel, and strategic positioning..."
            class="flex-1 w-full bg-transparent border-none focus:ring-0 p-0 font-mono text-sm leading-loose custom-scrollbar resize-none placeholder:text-muted-foreground/30">
          </textarea>

          <div class="mt-8 pt-6 border-t border-border/20 flex items-center justify-between">
            <p class="text-[9px] font-black uppercase tracking-widest text-muted-foreground opacity-40">Local Intel
              Store // Encrypted</p>
            <span class="text-[9px] font-black uppercase tracking-widest text-primary">Autosaved</span>
          </div>
        </div>

        <!-- People Block -->
        <div class="bg-card rounded-[2.5rem] border border-border/40 p-10 animate-fade-in-up delay-4">
          <div class="flex items-center justify-between mb-8">
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-muted-foreground">Personnel Hierarchy</h3>
            <button hlmBtn variant="ghost" size="icon-xs" class="h-8 w-8 rounded-full border border-border/40"
              (click)="startAddContact()" *ngIf="editingContactId() === null">
              <ng-icon name="lucidePlus"></ng-icon>
            </button>
          </div>

          <div class="space-y-4">
            <!-- Legacy HR Contact (Fallback if no structured contacts yet) -->

            <!-- Contact List -->
            @for (contact of details.contacts; track contact.id) {
            <div class="bg-muted/30 border border-border/20 rounded-[1.5rem] overflow-hidden transition-all"
              [class.bg-card]="editingContactId() === contact.id"
              [class.border-primary/30]="editingContactId() === contact.id">

              @if (editingContactId() !== contact.id) {
              <div class="p-5 flex items-center justify-between group hover:bg-muted/50 transition-all">
                <div class="flex items-center gap-4 w-full">
                  <div
                    class="h-12 w-12 rounded-2xl bg-primary/10 flex items-center justify-center text-primary font-black shrink-0">
                    {{ contact.name.charAt(0) }}
                  </div>

                  <div class="flex-1">
                    <p class="text-sm font-black tracking-tight">{{ contact.name }}</p>
                    <p class="text-[10px] font-bold text-muted-foreground uppercase">{{ contact.role }}</p>
                  </div>
                </div>

                <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  @if (contact.linkedIn) {
                  <a [href]="contact.linkedIn" target="_blank"
                    class="h-10 w-10 rounded-xl bg-card border border-border/40 flex items-center justify-center text-muted-foreground hover:text-primary transition-all">
                    <ng-icon name="lucideLinkedin"></ng-icon>
                  </a>
                  }
                  @if (contact.email) {
                  <a [href]="'mailto:' + contact.email"
                    class="h-10 w-10 rounded-xl bg-card border border-border/40 flex items-center justify-center text-muted-foreground hover:text-primary transition-all">
                    <ng-icon name="lucideExternalLink" size="16"></ng-icon>
                  </a>
                  }
                  <button (click)="startEditContact(contact)"
                    class="h-10 w-10 rounded-xl bg-card border border-border/40 flex items-center justify-center text-muted-foreground hover:text-primary transition-all">
                    <ng-icon name="lucidePencil" size="16"></ng-icon>
                  </button>
                  <button (click)="deleteContact(contact.id)"
                    class="h-10 w-10 rounded-xl bg-card border border-border/40 flex items-center justify-center text-muted-foreground hover:text-rose-500 transition-all">
                    <ng-icon name="lucideTrash2" size="16"></ng-icon>
                  </button>
                </div>
              </div>
              } @else {
              <!-- Inline Edit Form -->
              <div class="p-6 space-y-4 animate-in fade-in slide-in-from-top-2 duration-300">
                <div class="grid grid-cols-2 gap-3">
                  <div class="space-y-1.5">
                    <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">Member
                      Name</label>
                    <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.name()"
                      (ngModelChange)="editContactForm.name.set($event)" placeholder="e.g. Sarah Connor" autofocus />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">Rank /
                      Role</label>
                    <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.role()"
                      (ngModelChange)="editContactForm.role.set($event)" placeholder="e.g. Lead Technical Recruiter" />
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                  <div class="space-y-1.5">
                    <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">Signal
                      (LinkedIn)</label>
                    <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.linkedIn()"
                      (ngModelChange)="editContactForm.linkedIn.set($event)" placeholder="LinkedIn URL" />
                  </div>
                  <div class="space-y-1.5">
                    <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">Comms
                      (Email)</label>
                    <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.email()"
                      (ngModelChange)="editContactForm.email.set($event)" placeholder="Email Address" />
                  </div>
                </div>

                <div class="flex items-center justify-end gap-2 pt-2">
                  <button hlmBtn variant="ghost" size="sm" class="rounded-xl text-xs font-bold"
                    (click)="cancelContactEdit()">
                    Abort
                  </button>
                  <button hlmBtn variant="default" size="sm" class="rounded-xl text-xs font-bold px-6"
                    (click)="saveContact()">
                    Secure Entry
                  </button>
                </div>
              </div>
              }
            </div>
            }

            <!-- Add New Contact Form -->
            @if (editingContactId() === 0) {
            <div
              class="bg-card border-2 border-dashed border-primary/30 rounded-[1.5rem] p-6 space-y-4 animate-in fade-in zoom-in-95 duration-300">
              <div class="grid grid-cols-2 gap-3">
                <div class="space-y-1.5">
                  <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">New Member
                    Name</label>
                  <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.name()"
                    (ngModelChange)="editContactForm.name.set($event)" placeholder="Name" autofocus />
                </div>
                <div class="space-y-1.5">
                  <label class="text-[9px] font-black uppercase tracking-widest text-muted-foreground ml-1">Rank /
                    Role</label>
                  <input hlmInput size="sm" class="h-9 w-full rounded-xl" [ngModel]="editContactForm.role()"
                    (ngModelChange)="editContactForm.role.set($event)" placeholder="Role" />
                </div>
              </div>
              <div class="flex items-center justify-end gap-2 pt-2">
                <button hlmBtn variant="ghost" size="sm" class="rounded-xl text-xs font-bold font-sans"
                  (click)="cancelContactEdit()">
                  Abort
                </button>
                <button hlmBtn variant="default" size="sm" class="rounded-xl text-xs font-bold px-6 bg-primary"
                  (click)="saveContact()">
                  Enlist Personnel
                </button>
              </div>
            </div>
            }

            @if (!details.contacts?.length && !editingContactId()) {
            <div class="py-12 text-center border-2 border-dashed border-border/20 rounded-[2rem] bg-muted/5">
              <ng-icon name="lucideBuilding2" class="text-muted-foreground/20 text-4xl mb-3"></ng-icon>
              <p class="text-[10px] font-black text-muted-foreground/40 uppercase tracking-widest">No Intelligence
                Contacts Identified</p>
              <button hlmBtn variant="link" size="sm" class="mt-2 text-primary hover:text-primary/80 font-bold"
                (click)="startAddContact()">
                Identify New Contact
              </button>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- Column 3: News & Timeline (Span 3) -->
      <div class="lg:col-span-3 space-y-6">
        <!-- Recent News List -->
        <div class="bg-card rounded-[2.5rem] border border-border/40 p-8 h-full animate-fade-in-up delay-2">
          <div class="flex items-center justify-between mb-8">
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-muted-foreground">Market Signal</h3>
            @if (newsLoading()) {
            <ng-icon name="lucideLoader2" class="animate-spin text-primary"></ng-icon>
            }
          </div>

          <div class="space-y-4">
            @if (companyNews().length === 0 && !newsLoading()) {
            <p class="text-xs font-medium text-muted-foreground/40 text-center py-10">No recent market signals detected.
            </p>
            } @else {
            @for (news of companyNews(); track news.id) {
            <div class="news-item p-4 rounded-2xl bg-muted/30 border border-border/10">
              <div class="flex items-start justify-between gap-2 mb-2">
                <h5 class="text-sm font-bold leading-snug line-clamp-2">{{ news.title }}</h5>
                <ng-icon name="lucideExternalLink" class="text-muted-foreground/40 shrink-0 mt-1" size="14"></ng-icon>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-[10px] font-black uppercase text-primary">{{ news.source }}</span>
                <span class="text-[10px] font-bold text-muted-foreground/60">{{ formatDate(news.date) }}</span>
              </div>
            </div>
            }
            }
          </div>

          @if (details.applicationHistory.length > 0) {
          <div class="mt-8 pt-8 border-t border-border/20">
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-muted-foreground mb-6">Recent Log</h3>
            <div class="space-y-3">
              @for (app of details.applicationHistory.slice(0, 3); track app.id) {
              <button (click)="viewApplication(app.id)"
                class="w-full flex items-center justify-between p-3 rounded-xl bg-muted/20 border border-transparent hover:border-border/40 hover:bg-muted/40 transition-all text-left">
                <div>
                  <p class="text-xs font-black tracking-tight truncate max-w-[120px]">{{ app.position }}</p>
                  <p class="text-[9px] font-bold text-muted-foreground">{{ formatDate(app.appliedAt) }}</p>
                </div>
                <div class="h-1.5 w-1.5 rounded-full" [class]="getStatusDotClass(app.status)"></div>
              </button>
              }
            </div>
          </div>
          }
        </div>
      </div>

    </div>
  </div>
  }
</div>