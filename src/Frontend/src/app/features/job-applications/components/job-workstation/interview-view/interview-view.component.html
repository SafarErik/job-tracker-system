<div
    class="h-[calc(100vh-280px)] flex flex-col bg-zinc-950 rounded-[40px] border border-zinc-900 overflow-hidden relative group/dojo">

    <!-- AI Listening Badge -->
    @if (isRecording()) {
    <div
        class="absolute top-6 right-8 z-20 flex items-center gap-2 px-3 py-1 bg-red-500/10 border border-red-500/20 rounded-full animate-pulse">
        <div class="w-1.5 h-1.5 rounded-full bg-red-500"></div>
        <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">AI Listening...</span>
    </div>
    }

    <!-- Header -->
    <div class="px-8 py-5 border-b border-zinc-900 bg-zinc-950 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-zinc-900 border border-zinc-800 flex items-center justify-center">
                <ng-icon name="lucideSparkles" class="text-violet-500 text-sm"></ng-icon>
            </div>
            <h3 class="text-xs font-serif font-bold uppercase tracking-widest text-zinc-400">The Dojo / AI Coach</h3>
        </div>

        @if (messages().length > 0) {
        <button (click)="endSession()"
            class="text-[10px] font-bold text-zinc-600 hover:text-red-400 transition-colors uppercase tracking-widest">
            End Session
        </button>
        }
    </div>

    <!-- Conversation Area -->
    <div class="flex-1 overflow-y-auto p-8 md:p-12 space-y-8 scrollbar-thin scrollbar-thumb-zinc-900">
        @if (messages().length === 0) {
        <!-- Empty State: Starter Cards -->
        <div class="h-full flex flex-col items-center justify-center max-w-4xl mx-auto">
            <div class="text-center mb-12 animate-in fade-in slide-in-from-top-4 duration-700">
                <h2 class="text-2xl font-serif font-bold text-zinc-100 mb-3">Ready for Combat?</h2>
                <p class="text-sm text-zinc-500 max-w-md mx-auto">Select an interview simulation to begin your session
                    with the AI Coach.</p>
            </div>

            <div
                class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-200">
                @for (card of starterCards; track card.id) {
                <div (click)="startSession(card.id)"
                    class="bg-zinc-900/40 border border-zinc-900 hover:border-violet-500/50 hover:bg-zinc-900 transition-all cursor-pointer p-8 rounded-3xl group/card relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover/card:opacity-30 transition-opacity">
                        <ng-icon [name]="card.icon" class="text-4xl text-violet-500"></ng-icon>
                    </div>
                    <div
                        class="w-12 h-12 rounded-2xl bg-zinc-800 border border-zinc-700 flex items-center justify-center mb-6 group-hover/card:scale-110 transition-transform duration-500">
                        <ng-icon [name]="card.icon"
                            class="text-xl text-zinc-400 group-hover/card:text-violet-400 transition-colors"></ng-icon>
                    </div>
                    <h4 class="text-sm font-bold text-zinc-200 mb-2 truncate">{{ card.title }}</h4>
                    <p class="text-xs text-zinc-500 leading-relaxed">{{ card.description }}</p>
                </div>
                }
            </div>
        </div>
        } @else {
        <!-- Chat Interface -->
        <div class="max-w-3xl mx-auto space-y-10 pb-20">
            @for (msg of messages(); track msg.id) {
            <div [class.flex-row-reverse]="msg.sender === 'user'"
                class="flex items-start gap-4 animate-in fade-in slide-in-from-bottom-2 duration-300">

                <!-- Avatar -->
                <div [class]="msg.sender === 'ai' ? 'bg-zinc-900 border-zinc-800' : 'bg-violet-600 border-violet-500 shadow-lg shadow-violet-500/20'"
                    class="w-10 h-10 rounded-2xl border flex items-center justify-center shrink-0">
                    @if (msg.sender === 'ai') {
                    <ng-icon name="lucideSparkles" class="text-violet-400"></ng-icon>
                    } @else {
                    <span class="text-xs font-bold text-white uppercase">ME</span>
                    }
                </div>

                <!-- Bubble -->
                <div [class]="msg.sender === 'ai' 
                ? 'bg-zinc-800/80 border border-zinc-700/50 text-zinc-200 text-base leading-relaxed rounded-2xl rounded-tl-none shadow-2xl' 
                : 'bg-zinc-900 border border-zinc-800 text-zinc-100 text-sm rounded-2xl rounded-tr-none shadow-xl'"
                    class="p-5 max-w-[80%]">
                    <p class="whitespace-pre-wrap">{{ msg.text }}</p>
                    <div class="mt-2 text-[10px] text-zinc-600 font-medium">
                        {{ msg.timestamp | date:'shortTime' }}
                    </div>
                </div>
            </div>
            }
        </div>
        }
    </div>

    <!-- Combat Deck (Fixed Bottom Input) -->
    <div class="bg-zinc-950/80 backdrop-blur-md border-t border-zinc-900 p-8 shrink-0 relative z-20">
        <div class="max-w-2xl mx-auto flex items-center justify-between mb-2">

            <!-- Text Mode Toggle -->
            <button (click)="toggleTextMode()" [class.text-violet-400]="isTextMode()"
                [class.text-zinc-600]="!isTextMode()" class="p-4 hover:bg-zinc-900 rounded-2xl transition-all group">
                <ng-icon name="lucideKeyboard" class="text-xl group-hover:scale-110 transition-transform"></ng-icon>
            </button>

            <!-- Mic Button Container -->
            <div class="relative">
                @if (isRecording()) {
                <div class="absolute inset-0 rounded-full bg-red-500/20 animate-ping"></div>
                <div class="absolute -inset-2 rounded-full border border-red-500/30 animate-pulse"></div>
                }
                <button (click)="toggleRecording()" [class.bg-red-600]="isRecording()"
                    [class.border-red-500]="isRecording()" [class.bg-zinc-900]="!isRecording()"
                    [class.border-zinc-800]="!isRecording()" [attr.aria-pressed]="isRecording()"
                    [aria-label]="isRecording() ? 'Stop recording' : 'Start voice response'"
                    class="w-20 h-20 rounded-full border-2 flex items-center justify-center transition-all duration-300 hover:scale-105 active:scale-95 shadow-2xl relative z-10 group/mic">
                    <ng-icon name="lucideMic" [class.text-white]="isRecording()" [class.text-zinc-400]="!isRecording()"
                        class="text-3xl group-hover/mic:text-zinc-100 transition-colors" aria-hidden="true"></ng-icon>
                </button>
            </div>

            <!-- End Session Shortcut -->
            <button (click)="endSession()"
                class="p-4 text-zinc-600 hover:text-red-400 hover:bg-red-950/20 rounded-2xl transition-all group">
                <ng-icon name="lucideX"
                    class="text-xl group-hover:rotate-90 transition-transform duration-300"></ng-icon>
            </button>

        </div>

        <!-- Stable Container for Text Mode to avoid jumping -->
        <div class="h-0 overflow-hidden transition-all duration-300" [class.h-20]="isTextMode()"
            [class.mt-4]="isTextMode()">
            <div class="max-w-lg mx-auto">
                <div class="relative">
                    <input type="text" placeholder="Type your response..." [(ngModel)]="responseText"
                        (keyup.enter)="sendResponse()"
                        class="w-full bg-zinc-900 border border-zinc-800 rounded-2xl px-6 py-4 text-sm text-zinc-100 placeholder:text-zinc-600 focus:outline-none focus:border-violet-500/50 focus:ring-4 focus:ring-violet-500/5 transition-all">
                    <button (click)="sendResponse()"
                        class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 hover:text-violet-400 transition-colors"
                        aria-label="Send message">
                        <ng-icon name="lucideMessageSquare" class="text-lg"></ng-icon>
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>