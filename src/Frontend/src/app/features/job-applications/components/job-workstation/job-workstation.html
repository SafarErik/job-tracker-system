<div class="min-h-screen bg-background text-foreground pb-12 font-sans selection:bg-primary/20">
  <!-- Loading State -->
  @if (isLoading()) {
  <div class="flex flex-col items-center justify-center min-h-[60vh] gap-4 text-muted-foreground">
    <ng-icon name="lucideLoader2" class="text-4xl animate-spin text-primary"></ng-icon>
    <p class="text-sm font-medium">Initializing Mission Control...</p>
  </div>
  }

  <!-- Error State -->
  @if (error()) {
  <div class="flex flex-col items-center justify-center min-h-[60vh] gap-4 text-muted-foreground">
    <p>{{ error() }}</p>
    <button hlmBtn variant="outline" (click)="goBack()">
      <ng-icon name="lucideChevronLeft" class="mr-2"></ng-icon>
      Back to Applications
    </button>
  </div>
  }

  <!-- Main Content -->
  @if (application() && !isLoading()) {
  <div class="max-w-[1400px] mx-auto px-6 lg:px-8 pt-8 space-y-8">

    <!-- 1. Breadcrumbs -->
    <nav hlmBreadcrumb class="text-sm text-muted-foreground">
      <ol hlmBreadcrumbList>
        <li hlmBreadcrumbItem><a hlmBreadcrumbLink link="/" class="hover:text-primary transition-colors">Home</a></li>
        <li hlmBreadcrumbSeparator><ng-icon name="lucideChevronRight"></ng-icon></li>
        <li hlmBreadcrumbItem><a hlmBreadcrumbLink link="/applications"
            class="hover:text-primary transition-colors">Applications</a></li>
        <li hlmBreadcrumbSeparator><ng-icon name="lucideChevronRight"></ng-icon></li>
        <li hlmBreadcrumbItem><span hlmBreadcrumbPage class="font-medium text-foreground">{{ application()!.companyName
            }}</span></li>
      </ol>
    </nav>

    <!-- 2. Header & Controls -->
    <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-6 pb-2">
      <div class="space-y-3">
        <div class="flex items-baseline gap-4 flex-wrap">
          <h1 class="text-4xl md:text-5xl font-black tracking-tight text-foreground">{{ application()!.position }}</h1>
          <span class="text-2xl text-muted-foreground font-light">at</span>
          <a [routerLink]="['/companies', application()!.companyId]"
            class="text-3xl font-bold text-primary hover:text-primary/80 transition-colors hover:underline decoration-2 underline-offset-4">
            {{ application()!.companyName }}
          </a>
        </div>

        <!-- INLINE EDITING ROW (Dropdowns) -->
        <div class="flex flex-wrap gap-3 items-center">

          <!-- Status Dropdown -->
          <button [class]="getStatusClass(application()!.status)" [hlmDropdownMenuTrigger]="statusMenu"
            class="flex items-center gap-2 pr-2 shadow-sm hover:shadow-md cursor-pointer">
            <span>{{ getStatusLabel(application()!.status) }}</span>
            <ng-icon name="lucideChevronDown" size="14" class="opacity-50"></ng-icon>
          </button>
          <ng-template #statusMenu>
            <hlm-dropdown-menu class="w-48">
              <hlm-dropdown-menu-label>Update Status</hlm-dropdown-menu-label>
              <hlm-dropdown-menu-separator></hlm-dropdown-menu-separator>
              @for (option of statusOptions; track option.value) {
              <button hlmDropdownMenuItem (click)="selectStatus(option.value)">
                {{ option.label }}
              </button>
              }
            </hlm-dropdown-menu>
          </ng-template>

          <!-- Priority Dropdown -->
          <button [class]="getPriorityClass(application()!.priority)" [hlmDropdownMenuTrigger]="priorityMenu"
            class="flex items-center gap-2 rounded-lg pr-2 cursor-pointer shadow-sm hover:shadow-md">
            <span>{{ getPriorityLabel(application()!.priority) }}</span>
            <ng-icon name="lucideChevronDown" size="14" class="opacity-50"></ng-icon>
          </button>
          <ng-template #priorityMenu>
            <hlm-dropdown-menu class="w-40">
              <hlm-dropdown-menu-label>Set Priority</hlm-dropdown-menu-label>
              <hlm-dropdown-menu-separator></hlm-dropdown-menu-separator>
              @for (option of priorityOptions; track option.value) {
              <button hlmDropdownMenuItem (click)="selectPriority(option.value)">
                {{ option.label }}
              </button>
              }
            </hlm-dropdown-menu>
          </ng-template>

          <!-- Workplace Dropdown -->
          <button
            class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-muted/50 text-sm font-bold border border-border/60 hover:bg-muted transition-all shadow-sm cursor-pointer"
            [hlmDropdownMenuTrigger]="workplaceMenu">
            <ng-icon name="lucideMapPin" size="14" class="text-muted-foreground"></ng-icon>
            <span>{{ getWorkplaceLabel(application()!.workplaceType) }}</span>
            <ng-icon name="lucideChevronDown" size="14" class="opacity-50"></ng-icon>
          </button>
          <ng-template #workplaceMenu>
            <hlm-dropdown-menu class="w-40">
              <hlm-dropdown-menu-label>Workplace Type</hlm-dropdown-menu-label>
              <hlm-dropdown-menu-separator></hlm-dropdown-menu-separator>
              @for (option of workplaceOptions; track option.value) {
              <button hlmDropdownMenuItem (click)="selectWorkplace(option.value)">
                {{ option.label }}
              </button>
              }
            </hlm-dropdown-menu>
          </ng-template>

          @if (application()!.jobUrl) {
          <div class="h-4 w-px bg-border mx-1"></div>
          <a [href]="application()!.jobUrl" target="_blank"
            class="text-sm font-medium text-muted-foreground hover:text-primary flex items-center gap-1.5 transition-colors">
            Job Posting <ng-icon name="lucideExternalLink" size="12"></ng-icon>
          </a>
          }
        </div>
      </div>

      <!-- Match Score -->
      <div class="flex flex-col items-end">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-[0.65rem] uppercase tracking-[0.25em] font-black text-muted-foreground/80">Match
            Efficiency</span>
          <ng-icon name="lucideActivity" size="14" class="text-emerald-500"></ng-icon>
        </div>
        <div
          class="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-emerald-500 to-teal-600 drop-shadow-sm">
          {{ application()!.matchScore }}%
        </div>
      </div>
    </div>

    <!-- 3. Navigation Tabs (Dock Style) -->
    <div
      class="sticky top-20 z-40 bg-background/80 backdrop-blur-md rounded-2xl border border-border/40 p-1.5 w-fit shadow-lg shadow-black/5 mx-auto lg:mx-0">
      <div class="flex items-center gap-1">
        @for (tab of tabs; track tab.id) {
        <button (click)="setActiveTab(tab.id)"
          class="group relative flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-300 overflow-hidden"
          [class.text-primary]="activeTab() === tab.id" [class.text-muted-foreground]="activeTab() !== tab.id">

          @if (activeTab() === tab.id) {
          <div class="absolute inset-0 bg-secondary shadow-sm rounded-xl"></div>
          }

          <span class="relative z-10 flex items-center gap-2">
            <ng-icon [name]="tab.icon" size="16"></ng-icon>
            {{ tab.label }}
          </span>
        </button>
        }
      </div>
    </div>


    <!-- 4. CONTENT AREA (Bento Grid) -->
    <div class="min-h-[500px]">
      <!-- AI COACH TAB (Resume Optimizer) -->
      @if (activeTab() === 'coach') {
      <div class="space-y-8 max-w-6xl mx-auto">

        <div class="text-center mb-8">
          <h2 class="text-3xl font-black mb-2 flex items-center justify-center gap-3">
            <ng-icon name="lucideSparkles" class="text-amber-400"></ng-icon>
            Resume Optimizer
          </h2>
          <p class="text-muted-foreground">AI-powered suggestions to align your experience with this specific role.</p>
        </div>

        @if (!aiAnalysis()) {
        <div class="text-center py-20 bg-card rounded-3xl border border-border/40 border-dashed">
          <ng-icon name="lucideBrain" size="48" class="text-muted-foreground/30 mb-4"></ng-icon>
          <h3 class="text-xl font-bold mb-2">No Analysis Yet</h3>
          <p class="text-muted-foreground mb-6">Go to the <strong>Job Context</strong> tab and clicking "Generate
            Insights" to unlock this feature.</p>
          <button hlmBtn variant="outline" (click)="setActiveTab('context')">Go to Job Context</button>
        </div>
        } @else {
        <div class="grid grid-cols-1 gap-8">
          @for (enhancement of aiAnalysis()?.resumeEnhancements; track enhancement.id) {
          <div
            class="bg-card rounded-3xl border border-border/40 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
            <!-- Reasoning Header -->
            <div class="bg-indigo-500/5 border-b border-indigo-500/10 p-4 flex items-center gap-3">
              <ng-icon name="lucideLightbulb" class="text-indigo-500" size="18"></ng-icon>
              <span class="text-sm font-medium text-indigo-700 dark:text-indigo-300">
                <strong>AI Insight:</strong> {{ enhancement.reasoning }}
              </span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2">
              <!-- Original -->
              <div class="p-8 border-b lg:border-b-0 lg:border-r border-border/40 bg-rose-500/5">
                <div class="flex items-center justify-between mb-4">
                  <span
                    class="text-xs font-bold uppercase tracking-widest text-rose-600 dark:text-rose-400">Original</span>
                  <ng-icon name="lucideArrowRight" class="lg:hidden text-muted-foreground"></ng-icon>
                </div>
                <p
                  class="text-muted-foreground line-through decoration-rose-500/50 decoration-2 font-mono text-sm leading-relaxed">
                  "{{ enhancement.originalBullet }}"
                </p>
              </div>

              <!-- Rebranded -->
              <div class="p-8 bg-emerald-500/5 relative group">
                <div class="flex items-center justify-between mb-4">
                  <span
                    class="text-xs font-bold uppercase tracking-widest text-emerald-600 dark:text-emerald-400 flex items-center gap-2">
                    <ng-icon name="lucideSparkles" size="14"></ng-icon> Optimized
                  </span>
                  <button hlmBtn size="sm" variant="ghost"
                    class="h-6 text-xs text-emerald-600 hover:text-emerald-700 hover:bg-emerald-500/10"
                    (click)="copyToClipboard(enhancement.rebrandedBullet)">
                    Copy
                  </button>
                </div>
                <textarea readonly
                  class="w-full h-24 bg-transparent border-none resize-none focus:ring-0 text-foreground font-medium text-lg leading-relaxed outline-none">
{{ enhancement.rebrandedBullet }}
                                </textarea>

                <div class="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                  <span class="text-[10px] text-emerald-600/60 font-mono">Click to copy</span>
                </div>
              </div>
            </div>
          </div>
          }
        </div>
        }
      </div>
      }
      @if (activeTab() === 'overview') {
      <div class="p-8 border rounded-3xl bg-card">
        <h2 class="text-xl font-bold mb-4">Overview Tab Active</h2>
        <p>Applied On: {{ formatDate(application()!.appliedAt) }}</p>
        <p>Job Type: {{ getJobTypeLabel(application()!.jobType) }}</p>
      </div>
      }
      @else {
      <div class="p-8 border rounded-3xl bg-card">
        <h2 class="text-xl font-bold mb-4">{{ activeTab() | titlecase }} Tab Content Placeholder</h2>
        <p>Content temporarily simplified for debugging.</p>
      </div>
      }
    </div>
  </div>
  }

  @if (!application() && !isLoading() && !error()) {
  <div class="max-w-7xl mx-auto px-6 lg:px-8 pt-20 text-center">
    <div class="bg-card rounded-3xl border border-border/40 p-12 max-w-md mx-auto shadow-sm">
      <div class="p-4 rounded-full bg-primary/10 w-fit mx-auto mb-6 text-primary">
        <ng-icon name="lucideFileSearch" size="32"></ng-icon>
      </div>
      <h2 class="text-2xl font-bold mb-2">No Application Selected</h2>
      <p class="text-muted-foreground mb-8">Select an application from the dashboard to launch the Career Co-pilot.</p>
      <button hlmBtn (click)="goBack()" class="w-full">Go to Dashboard</button>
    </div>
  </div>
  }
</div>