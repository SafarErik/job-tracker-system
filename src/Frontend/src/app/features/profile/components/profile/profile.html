<div class="min-h-screen bg-background text-foreground selection:bg-primary/30">
  <div class="container mx-auto px-4 py-8 lg:px-8 space-y-8 pb-20">


    <!-- Loading State -->
    @if (isLoading()) {
    <div class="flex flex-col items-center justify-center py-32 space-y-4 animate-pulse">
      <ng-icon name="lucideLoader2" class="h-10 w-10 animate-spin text-violet-500"></ng-icon>
      <p class="text-muted-foreground font-medium tracking-widest uppercase text-xs">Accessing Personnel Dossier...</p>
    </div>
    }

    <!-- Error State -->
    @if (error()) {
    <app-error-state title="Profile Unavailable" [message]="error()!" icon="lucideUserX" (retry)="loadProfile()">
    </app-error-state>
    }

    <!-- Main Content -->
    @if (!isLoading() && !error() && profile()) {

    <!-- 1. HEADER: The Identity Engine -->
    <div class="relative overflow-hidden rounded-[2.5rem] border border-border bg-card/40 backdrop-blur-xl shadow-2xl">

      <div class="relative p-8 md:p-12 flex flex-col md:flex-row items-center md:items-start gap-10">

        <!-- Avatar Block -->
        <div class="relative group">
          <div
            class="absolute -inset-2 rounded-full bg-linear-to-tr from-violet-600 to-fuchsia-500 blur-lg opacity-40 group-hover:opacity-100 transition-opacity duration-700">
          </div>

          <div
            class="relative h-40 w-40 rounded-full border-4 border-background ring-1 ring-white/10 overflow-hidden shadow-2xl bg-muted">
            @if (profile()!.profilePictureUrl) {
            <img [src]="profile()!.profilePictureUrl" alt="Profile" class="h-full w-full object-cover" />
            } @else {
            <div
              class="h-full w-full flex items-center justify-center bg-violet-500/10 text-violet-400 text-4xl font-serif">
              {{ profile()!.firstName?.charAt(0) }}{{ profile()!.lastName?.charAt(0) }}
            </div>
            }

            <!-- Upload Overlay -->
            <div
              class="absolute inset-0 flex items-center justify-center bg-background/80 opacity-0 group-hover:opacity-100 transition-all duration-300 cursor-pointer"
              (click)="fileInput.click()">
              <ng-icon name="lucideUserPen" class="text-foreground h-8 w-8"></ng-icon>
            </div>
            <input type="file" #fileInput (change)="onFileSelected($event)" accept="image/*" class="hidden" />
          </div>

          <!-- Upload Progress -->
          @if (isUploadingPicture()) {
          <div class="absolute inset-0 flex items-center justify-center rounded-full bg-background/60 backdrop-blur-sm">
            <ng-icon name="lucideLoader2" class="animate-spin h-8 w-8 text-violet-400"></ng-icon>
          </div>
          }
        </div>

        <!-- Identity Details -->
        <div class="flex-1 text-center md:text-left space-y-4" [formGroup]="profileForm">

          <div class="space-y-1">
            <div class="flex items-center justify-center md:justify-start gap-3">
              <span
                class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest bg-violet-500/20 text-violet-400 border border-violet-500/30">Verified
                Operative</span>
              <button hlmBtn variant="ghost" size="icon" (click)="uiService.openProfileSettings()"
                class="h-8 w-8 rounded-lg text-muted-foreground hover:text-foreground hover:bg-muted">
                <ng-icon name="lucideSettings" class="h-4 w-4"></ng-icon>
              </button>
            </div>

            <!-- Name: Edit on Click -->
            <div class="min-h-[60px] flex items-center justify-center md:justify-start">
              @if (editingField() !== 'name') {
              <h1 (click)="startEditing('name')"
                class="text-4xl md:text-5xl font-serif font-bold tracking-tight hover:text-violet-400 cursor-pointer transition-all group flex items-center gap-4">
                {{ profile()!.firstName }} {{ profile()!.lastName }}
                <ng-icon name="lucidePencil"
                  class="opacity-0 group-hover:opacity-100 h-5 w-5 text-muted-foreground"></ng-icon>
                @if (lastSavedField() === 'firstName' || lastSavedField() === 'lastName') {
                <ng-icon @fadeIn name="lucideCheck" class="h-6 w-6 text-emerald-500"></ng-icon>
                }
              </h1>
              } @else {
              <div @fadeScale class="flex gap-3 items-center w-full max-w-xl">
                <input hlmInput formControlName="firstName"
                  class="text-3xl md:text-4xl font-serif font-bold h-14 bg-input/50 border-border text-foreground focus:border-violet-500/50"
                  placeholder="First" (blur)="saveField('firstName')" (keydown.enter)="saveField('firstName')"
                  autofocus>
                <input hlmInput formControlName="lastName"
                  class="text-3xl md:text-4xl font-serif font-bold h-14 bg-input/50 border-border text-foreground focus:border-violet-500/50"
                  placeholder="Last" (blur)="saveField('lastName')" (keydown.enter)="saveField('lastName')">
              </div>
              }
            </div>
          </div>

          <!-- Title: Edit on Click -->
          <div class="min-h-[32px]">
            @if (editingField() !== 'currentJobTitle') {
            <p (click)="startEditing('currentJobTitle')"
              class="text-xl text-muted-foreground font-medium flex items-center justify-center md:justify-start gap-2 hover:text-foreground cursor-pointer transition-colors group w-fit">
              <ng-icon name="lucideBriefcase" class="h-5 w-5 text-violet-500 opacity-70"></ng-icon>
              {{ profile()!.currentJobTitle || 'Specialized Operative' }}
              <ng-icon name="lucidePencil"
                class="opacity-0 group-hover:opacity-100 h-4 w-4 text-muted-foreground"></ng-icon>
              @if (lastSavedField() === 'currentJobTitle') {
              <ng-icon @fadeIn name="lucideCheck" class="h-4 w-4 text-emerald-500"></ng-icon>
              }
            </p>
            } @else {
            <div @fadeScale class="flex items-center gap-2 max-w-md">
              <input hlmInput formControlName="currentJobTitle"
                class="h-10 w-full font-medium bg-input/50 border-border text-foreground focus:border-violet-500/50"
                placeholder="Job Title" (blur)="saveField('currentJobTitle')"
                (keydown.enter)="saveField('currentJobTitle')" autofocus>
            </div>
            }
          </div>

          <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 pt-4">
            <div
              class="flex items-center gap-2 px-4 py-1.5 rounded-xl bg-card border border-border text-sm text-muted-foreground">
              <ng-icon name="lucideMail" class="h-4 w-4"></ng-icon>
              {{ profile()!.email }}
            </div>

            <!-- Years Exp: Edit on Click -->
            <div
              class="flex items-center gap-2 px-4 py-1.5 rounded-xl bg-card border border-border text-sm text-muted-foreground cursor-pointer hover:bg-accent hover:text-foreground transition-all group"
              (click)="startEditing('yearsOfExperience')">
              <ng-icon name="lucideSparkles" class="h-4 w-4 text-violet-400"></ng-icon>
              @if (editingField() !== 'yearsOfExperience') {
              <span>{{ profile()!.yearsOfExperience || 0 }} Years Experience</span>
              } @else {
              <input hlmInput type="number" formControlName="yearsOfExperience"
                class="h-5 w-12 text-center p-0 bg-transparent border-none focus:ring-0 text-foreground font-bold"
                (blur)="saveField('yearsOfExperience')" (keydown.enter)="saveField('yearsOfExperience')" autofocus>
              }
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- 2. BENTO GRID: The Intelligence Core -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 auto-rows-min">

      <!-- Bio / Narrative (Large Card, 2x2) -->
      <div hlmCard
        class="lg:col-span-2 lg:row-span-2 border-border bg-card/40 hover:border-violet-500/30 transition-all group relative overflow-hidden flex flex-col">
        >
        <div class="p-8 space-y-6 flex-1">
          <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 rounded-lg bg-violet-500/10 flex items-center justify-center text-violet-400">
                <ng-icon name="lucideUserPen" class="h-4 w-4"></ng-icon>
              </div>
              <h2 class="text-xl font-serif font-bold">Professional Narrative</h2>
            </div>

            <button hlmBtn variant="outline" size="sm" (click)="polishBio()"
              [disabled]="isPolishingBio() || !profile()!.bio"
              class="rounded-xl border-border bg-background/50 text-muted-foreground hover:text-violet-400 hover:border-violet-500/30 transition-all gap-2">
              @if (isPolishingBio()) {
              <ng-icon name="lucideLoader2" class="animate-spin h-3.5 w-3.5"></ng-icon>
              <span>Drafting...</span>
              } @else {
              <ng-icon name="lucideSparkles" class="h-3.5 w-3.5"></ng-icon>
              <span>AI Polish</span>
              }
            </button>
          </div>

          <div class="relative flex-1">
            @if (editingField() !== 'bio') {
            <div (click)="startEditing('bio')"
              class="cursor-pointer min-h-[250px] p-6 -m-4 rounded-2xl hover:bg-accent/50 transition-all relative">
              @if (profile()!.bio) {
              <p class="text-muted-foreground leading-relaxed text-lg whitespace-pre-wrap selection:bg-violet-500/50">{{
                profile()!.bio }}</p>
              } @else {
              <div
                class="flex flex-col items-center justify-center py-12 text-center text-muted-foreground italic gap-4">
                <ng-icon name="lucidePencil" class="h-10 w-10 opacity-20"></ng-icon>
                Define your professional narrative...
              </div>
              }
              <div
                class="absolute bottom-4 right-4 text-[10px] font-black uppercase tracking-widest text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity">
                Click to Edit
              </div>
            </div>
            } @else {
            <form [formGroup]="profileForm" @fadeScale class="h-full">
              <textarea hlmInput formControlName="bio"
                class="w-full min-h-[300px] resize-none bg-background/50 border-border text-foreground text-lg leading-relaxed p-6 rounded-2xl focus:border-violet-500/50"
                placeholder="Tell your professional story..." (blur)="saveField('bio')" autofocus></textarea>
              <p class="text-[10px] text-muted-foreground mt-3 text-right uppercase font-black tracking-widest">Saving
                automatically on blur</p>
            </form>
            }
          </div>
        </div>
      </div>

      <!-- Stats Grid (Right of Bio) -->
      <div hlmCard
        class="border-border bg-card/40 p-6 flex flex-col justify-between hover:border-violet-500/30 transition-all relative overflow-hidden group">
        <!-- Success Gauge -->
        <div class="relative z-10">
          <h3 class="text-[10px] font-black uppercase tracking-widest text-muted-foreground mb-4">Tactical Success</h3>
          <div class="flex items-end justify-between">
            <div>
              <div class="text-4xl font-serif font-bold text-violet-400">{{ stats()?.successRate || 0 }}%</div>
              <p class="text-xs text-muted-foreground mt-1">Application ROI</p>
            </div>
            <div class="h-12 w-12 flex items-center justify-center">
              <svg class="h-full w-full -rotate-90" viewBox="0 0 36 36">
                <path class="text-muted"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke="currentColor" stroke-width="3" />
                <path class="text-violet-500 transition-all duration-1000 ease-out"
                  [attr.stroke-dasharray]="(stats()?.successRate || 0) + ', 100'"
                  d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none"
                  stroke="currentColor" stroke-width="3" stroke-linecap="round" />
              </svg>
              <ng-icon name="lucideTarget" class="absolute h-4 w-4 text-violet-500"></ng-icon>
            </div>
          </div>
        </div>
        <div
          class="absolute -bottom-8 -right-8 h-24 w-24 bg-violet-600/5 rounded-full blur-2xl group-hover:bg-violet-600/10 transition-colors">
        </div>
      </div>

      <div hlmCard
        class="border-border bg-card/40 p-6 flex flex-col justify-between hover:border-violet-500/30 transition-all">
        <div class="h-8 w-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-400">
          <ng-icon name="lucideSparkles" class="h-4 w-4"></ng-icon>
        </div>
        <div>
          <div class="text-3xl font-serif font-bold text-foreground">{{ stats()?.offersReceived || 0 }}</div>
          <p class="text-[10px] font-black uppercase tracking-widest text-muted-foreground">Offers Secured</p>
        </div>
      </div>

      <!-- AI Career Insights (Wide Card, Bottom Right) -->
      <div class="lg:col-span-2 hlmCard border-violet-500/20 bg-violet-500/5 p-8 relative overflow-hidden group">
        <div
          class="absolute top-0 right-0 p-32 bg-violet-600/5 rounded-full blur-[80px] pointer-events-none group-hover:bg-violet-600/10 transition-colors">
        </div>

        <div class="relative z-10 flex flex-col h-full justify-between gap-6">
          <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-lg bg-violet-500/20 flex items-center justify-center text-violet-400">
              <ng-icon name="lucideTarget" class="h-4 w-4"></ng-icon>
            </div>
            <h3 class="text-sm font-black uppercase tracking-[0.2em] text-violet-300">Tactical Edge</h3>
          </div>

          <div class="grid md:grid-cols-2 gap-8">
            <div class="space-y-4">
              <div class="space-y-1">
                <p class="text-[10px] font-black uppercase tracking-widest text-muted-foreground">Next Level Path</p>
                <p class="text-lg font-serif font-bold text-foreground">{{ careerInsights()?.nextLevelPath || 'Strategic
                  Leadership' }}</p>
              </div>
              <div class="space-y-1 relative">
                <p class="text-[10px] font-black uppercase tracking-widest text-muted-foreground">Salary Benchmark</p>
                <div class="flex items-center gap-4">
                  <div class="text-lg font-mono font-bold text-emerald-400">{{ (careerInsights()?.salaryBenchmark || 0)
                    |
                    currency:'USD':'symbol':'1.0-0' }}</div>
                  <!-- Miniature Salary Gauge -->
                  <div class="h-10 w-20 relative overflow-hidden">
                    <svg class="w-full h-full rotate-180" viewBox="0 0 100 50">
                      <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#18181b" stroke-width="12" />
                      <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#10b981" stroke-width="12"
                        stroke-dasharray="125.6"
                        [attr.stroke-dashoffset]="125.6 * (1 - ((careerInsights()?.salaryBenchmark || 0) / 250000))" />
                    </svg>
                  </div>
                </div>
              </div>
            </div>
            <div class="space-y-4">
              <div class="p-4 rounded-xl bg-background/50 border border-border space-y-2">
                <p class="text-[10px] font-black uppercase tracking-widest text-violet-400/70">Missing Key</p>
                <p class="text-sm font-medium text-muted-foreground">Deploy <span class="text-violet-400 font-bold">{{
                    careerInsights()?.missingKey || 'Unknown' }}</span> to increase match score globally.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Skills Engine (Right Sidebar Style / Full Row on Mobile) -->
      <div class="lg:col-span-4 hlmCard border-border bg-card/40 overflow-hidden">
        <div class="p-8 space-y-8">
          <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
            <div class="space-y-1">
              <h2 class="text-2xl font-serif font-bold flex items-center gap-3">
                <div class="h-8 w-8 rounded-lg bg-emerald-500/10 flex items-center justify-center text-emerald-400">
                  <ng-icon name="lucideGraduationCap" class="h-4 w-4"></ng-icon>
                </div>
                The Arsenal
              </h2>
              <p class="text-[10px] font-black uppercase tracking-widest text-muted-foreground">Resource Inventory â€¢ {{
                userSkills().length }} Total</p>
            </div>

            <!-- Skill Search -->
            <div class="w-full md:w-96 relative group">
              <ng-icon name="lucideSearch"
                class="absolute left-3 top-3.5 h-4 w-4 text-muted-foreground group-focus-within:text-violet-500 transition-colors"></ng-icon>
              <input [formControl]="skillSearchControl" placeholder="Scan for new skills..."
                class="w-full pl-10 h-11 bg-input/50 border border-border rounded-xl text-foreground placeholder:text-muted-foreground focus:border-violet-500/50 outline-none transition-all"
                (keydown.enter)="onSkillInputEnter()" />

              <!-- Dropdown for Results -->
              @if (skillSearchTerm() && (filteredSkills.length > 0 || addableSkillName)) {
              <div
                class="absolute top-full left-0 right-0 mt-2 bg-card border border-border rounded-xl shadow-2xl z-50 overflow-hidden backdrop-blur-xl">
                <div class="max-h-60 overflow-y-auto custom-scrollbar">
                  <div class="p-2 space-y-1">
                    @for (skill of filteredSkills.slice(0, 5); track skill.id) {
                    <button (click)="addSkill(skill)"
                      class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted text-sm text-left transition-colors">
                      <ng-icon name="lucidePlus" class="h-4 w-4 text-violet-400"></ng-icon>
                      {{ skill.name }}
                    </button>
                    }
                    @if (addableSkillName) {
                    <button (click)="addCustomSkillFromInput()"
                      class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted text-sm text-left transition-colors border-t border-border mt-1">
                      <ng-icon name="lucidePlus" class="h-4 w-4 text-emerald-400"></ng-icon>
                      Add custom: "{{ addableSkillName }}"
                    </button>
                    }
                  </div>
                </div>
              </div>
              }
            </div>
          </div>

          <!-- Skill Cloud -->
          <div class="grid md:grid-cols-4 gap-8">
            <!-- Current Arsenal -->
            <div class="md:col-span-3 space-y-6">
              <div class="flex flex-wrap gap-3">
                @for (skill of userSkills(); track skill.id) {
                <div @fadeScale
                  class="group relative flex items-center gap-2 pl-4 pr-3 py-2 rounded-xl text-sm font-bold uppercase tracking-wider backdrop-blur-sm border transition-all cursor-default select-none overflow-hidden"
                  [class.bg-violet-500/10]="skill.category === 'Frontend'"
                  [class.border-violet-500/30]="skill.category === 'Frontend'"
                  [class.text-violet-300]="skill.category === 'Frontend'"
                  [class.bg-blue-500/10]="skill.category === 'Backend'"
                  [class.border-blue-500/30]="skill.category === 'Backend'"
                  [class.text-blue-300]="skill.category === 'Backend'"
                  [class.bg-emerald-500/10]="skill.category === 'DevOps'"
                  [class.border-emerald-500/30]="skill.category === 'DevOps'"
                  [class.text-emerald-300]="skill.category === 'DevOps'"
                  [class.bg-card/50]="!['Frontend', 'Backend', 'DevOps'].includes(skill.category || '')"
                  [class.border-border/50]="!['Frontend', 'Backend', 'DevOps'].includes(skill.category || '')"
                  [class.text-muted-foreground]="!['Frontend', 'Backend', 'DevOps'].includes(skill.category || '')">

                  <span class="relative z-10">{{ skill.name }}</span>

                  <button (click)="removeSkill(skill)"
                    class="relative z-10 ml-1 opacity-0 group-hover:opacity-100 hover:text-white transition-opacity">
                    <ng-icon name="lucideX" class="h-3.5 w-3.5"></ng-icon>
                  </button>

                  <!-- Hover Glow -->
                  <div class="absolute inset-0 bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </div>
                }
              </div>
            </div>

            <!-- AI Recommendations -->
            <div class="space-y-4">
              <div class="flex items-center gap-2">
                <ng-icon name="lucideSparkles" class="h-3.5 w-3.5 text-violet-400"></ng-icon>
                <h4 class="text-[10px] font-black uppercase tracking-widest text-muted-foreground">AI Recommendations
                </h4>
              </div>
              <div class="flex flex-col gap-2">
                @for (skill of suggestedSkills(); track skill.id) {
                <button (click)="addSkill(skill)"
                  class="flex items-center justify-between p-3 rounded-xl bg-card border border-border hover:border-violet-500/30 transition-all group">
                  <span class="text-sm text-muted-foreground group-hover:text-foreground">{{ skill.name }}</span>
                  <ng-icon name="lucidePlus"
                    class="h-3.5 w-3.5 text-muted-foreground group-hover:text-violet-400"></ng-icon>
                </button>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
    }
  </div>
</div>